<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EndoAI — Case Details</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .detail-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }
    .left-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      position: sticky;
      top: 1rem;
      align-self: start;
    }
    .detail-section {
      background: var(--card);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .detail-section h2 {
      margin: 0 0 1rem 0;
      color: var(--accent);
      font-size: 1.25rem;
    }
    .detail-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 1rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      font-weight: 600;
      color: var(--text-light);
    }
    .detail-value {
      color: var(--text);
    }
    .image-container {
      background: var(--card);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .image-container h3 {
      margin: 0 0 1rem 0;
      color: var(--accent);
    }
    .image-container img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    @media (max-width: 1024px) {
      .detail-container {
        grid-template-columns: 1fr;
      }
      .right-column {
        position: static;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="page-header">
      <h1>Case Details</h1>
      <p>Complete information for case <strong id="caseId"></strong></p>
      <div style="margin-top: 1rem; display: flex; gap: 1rem;">
        <a href="results.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">← Back to Results</a>
        <span style="color: var(--border);">|</span>
        <a href="upload.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">Upload Another →</a>
      </div>
    </div>

    <div id="loading">Loading case details...</div>
    <div id="error" style="display: none; color: var(--error);"></div>
    
    <div id="caseContent" style="display: none;">
      <div class="detail-container">
        <!-- Left Column: Case Information -->
        <div class="left-column">
          <div class="detail-section">
            <h2>Case Information</h2>
            <div class="detail-row">
              <div class="detail-label">Slide ID:</div>
              <div class="detail-value" id="slideId"></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Patient ID:</div>
              <div class="detail-value" id="patientId"></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Status:</div>
              <div class="detail-value" id="status"></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Uploaded:</div>
              <div class="detail-value" id="uploadedAt"></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Uploaded By:</div>
              <div class="detail-value" id="userId"></div>
            </div>
          </div>

          <div class="detail-section">
            <h2>Analysis Results</h2>
            <div class="detail-row">
              <div class="detail-label">Prediction:</div>
              <div class="detail-value" id="prediction"></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Confidence:</div>
              <div class="detail-value" id="confidence"></div>
            </div>
            <div id="confidenceExplanation" style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px; font-size: 0.9rem; line-height: 1.6;">
              <strong>About Confidence:</strong><br>
              The confidence score indicates how certain the AI model is about its prediction. However, <strong>high confidence does not guarantee accuracy</strong> if the model itself has low overall performance.
            </div>
          </div>

          <div class="detail-section" id="modelInfoSection">
            <h2>Model Information</h2>
            <div class="detail-row">
              <div class="detail-label">Model Accuracy:</div>
              <div class="detail-value" id="modelAccuracy">Loading...</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Model Status:</div>
              <div class="detail-value" id="modelStatus">Loading...</div>
            </div>
            <div id="modelWarning" style="display: none; margin-top: 1rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9rem; line-height: 1.6;">
              <strong>⚠️ Low Model Accuracy</strong><br>
              The current model has low validation accuracy and is not yet suitable for clinical use. Predictions may be incorrect regardless of confidence scores. A new model is currently being trained to improve accuracy.
            </div>
            <div id="modelGood" style="display: none; margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px; font-size: 0.9rem; line-height: 1.6;">
              <strong>✓ Production-Ready Model</strong><br>
              This model has achieved good validation accuracy and can provide reliable predictions for endometrial pathology classification.
            </div>
          </div>

          <div class="detail-section">
            <h2>Clinical Information</h2>
            <div class="detail-row">
              <div class="detail-label">Age:</div>
              <div class="detail-value" id="age"></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Clinical History:</div>
              <div class="detail-value" id="clinicalHistory"></div>
            </div>
          </div>
        </div>

        <!-- Right Column: Images -->
        <div class="right-column">
          <div class="image-container">
            <h3>Original Image</h3>
            <img id="originalImage" src="" alt="Original slide image" />
            <div id="originalImageError" style="display: none; color: var(--error); margin-top: 1rem;">Image not available</div>
          </div>
          
          <div class="image-container" id="gradcamContainer" style="display: none;">
            <h3>GradCAM Visualization</h3>
            <img id="gradcamImage" src="" alt="GradCAM heatmap" />
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/navbar.js"></script>
  <script src="js/utils.js"></script>
  <script>
    // Initialize navbar
    renderNavbar('details');

    // Get case ID from URL
    const params = new URLSearchParams(window.location.search);
    const caseId = params.get('id');
    
    if (!caseId) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = 'No case ID provided';
    } else {
      document.getElementById('caseId').textContent = caseId;
      loadCaseDetails(caseId);
    }

    async function loadCaseDetails(id) {
      try {
        // Load case metadata
        const response = await API.get('/cases');
        const cases = response.cases || response;
        const caseData = cases.find(c => c.id === id);
        
        if (!caseData) {
          throw new Error('Case not found');
        }

        // Populate case information
        document.getElementById('slideId').textContent = caseData.slide_id || id;
        document.getElementById('patientId').textContent = caseData.patient_id || 'N/A';
        document.getElementById('status').innerHTML = `<span class="status-${caseData.status || 'unknown'}">${caseData.status || 'unknown'}</span>`;
        document.getElementById('uploadedAt').textContent = caseData.uploaded_at ? new Date(caseData.uploaded_at).toLocaleString() : 'N/A';
        document.getElementById('userId').textContent = caseData.user_id || 'N/A';
        
        // Populate analysis results
        document.getElementById('prediction').textContent = caseData.prediction || 'Pending';
        document.getElementById('confidence').textContent = caseData.confidence ? (caseData.confidence * 100).toFixed(1) + '%' : 'N/A';
        
        // Populate clinical information
        document.getElementById('age').textContent = caseData.age || 'Not specified';
        document.getElementById('clinicalHistory').textContent = caseData.clinical_history || 'No clinical history provided';
        
        // Load model metadata to show accuracy
        loadModelMetadata();
        
        // Load original image
        const originalImg = document.getElementById('originalImage');
        const originalError = document.getElementById('originalImageError');
        const imageUrl = `/cases/${id}/image`;
        console.log('Loading original image from:', imageUrl);
        originalImg.src = imageUrl;
        originalImg.onerror = (e) => {
          console.error('Failed to load original image:', e);
          originalImg.style.display = 'none';
          originalError.style.display = 'block';
        };
        originalImg.onload = () => {
          console.log('Original image loaded successfully');
          originalImg.style.display = 'block';
          originalError.style.display = 'none';
        };
        
        // Load GradCAM if available
        if (caseData.gradcam_data || caseData.status === 'completed') {
          const gradcamContainer = document.getElementById('gradcamContainer');
          const gradcamImg = document.getElementById('gradcamImage');
          gradcamContainer.style.display = 'block';
          gradcamImg.src = `/cases/${id}/gradcam`;
          gradcamImg.onerror = () => {
            gradcamContainer.style.display = 'none';
          };
        }
        
        // Show content, hide loading
        document.getElementById('loading').style.display = 'none';
        document.getElementById('caseContent').style.display = 'block';
        
      } catch (err) {
        console.error('Error loading case:', err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = 'Failed to load case details: ' + err.message;
      }
    }
    
    async function loadModelMetadata() {
      try {
        // Fetch model metadata from the backend
        const response = await fetch('/model/info');
        const modelData = await response.json();
        
        const modelAccuracyElement = document.getElementById('modelAccuracy');
        const modelStatusElement = document.getElementById('modelStatus');
        const modelWarning = document.getElementById('modelWarning');
        const modelGood = document.getElementById('modelGood');
        
        const modelAccuracy = modelData.validation_accuracy;
        
        if (modelAccuracy !== null && modelAccuracy !== undefined) {
          modelAccuracyElement.textContent = modelAccuracy.toFixed(1) + '%';
          
          // Determine model status based on accuracy thresholds
          if (modelAccuracy >= 85) {
            modelStatusElement.innerHTML = '<span style="color: #4caf50; font-weight: 600;">Excellent</span>';
            modelGood.style.display = 'block';
          } else if (modelAccuracy >= 80) {
            modelStatusElement.innerHTML = '<span style="color: #8bc34a; font-weight: 600;">Good</span>';
            modelGood.style.display = 'block';
          } else if (modelAccuracy >= 70) {
            modelStatusElement.innerHTML = '<span style="color: #ff9800; font-weight: 600;">Moderate - Use with Caution</span>';
            modelWarning.style.display = 'block';
          } else {
            modelStatusElement.innerHTML = '<span style="color: #f44336; font-weight: 600;">Low - Not Production Ready</span>';
            modelWarning.style.display = 'block';
          }
        } else {
          modelAccuracyElement.textContent = 'Unknown';
          modelStatusElement.textContent = modelData.status || 'Unknown';
        }
      } catch (err) {
        console.error('Could not load model metadata:', err);
        document.getElementById('modelAccuracy').textContent = 'Unknown';
        document.getElementById('modelStatus').textContent = 'Unknown';
      }
    }
  </script>
</body>
</html>
